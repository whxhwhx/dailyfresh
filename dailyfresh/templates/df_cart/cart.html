{%extends 'base_bot_head.html'%}
{%block head%}
<script type="text/javascript" src="/static/js/jquery-1.12.4.min.js"></script>
<script>
	// delete
	function cart_del(cart_id){
		del = confirm('确定要删除吗?')
		if(del){
			$.get('/cart/delete/' + cart_id, function(data){
				if(data.ok == 1){
					$('ul').remove('#' + cart_id);
					total();
				}
			})
		}
	}

	// total
	function total(){
		total1 = 0;
		total_count1 = 0;
		total_count2 = 0;

		$('.col07').each(function(){
			// 获取该商品要购买的数量
			count = $(this).prev().find('input').val();
			price = $(this).prev().prev().text();
			// 小计total0
			total0 = parseFloat(count) * parseFloat(price);
			$(this).text(total0.toFixed(2));

			// 勾选上了，才会计入总计
			if($(this).parent().children(':first').find('input').prop('checked')){
				total1 += total0;
				total_count2 ++;
			}
			total_count1 ++;

		});

		//  显示总计
		$('#total').text(total1.toFixed(2));
		$('.total_count1').text(total_count1);
		$('.total_count2').text(total_count2);



	}

	$(function(){
		total();
		// select all
		$('#check_all').click(function(){
			var state = $(this).prop('checked');
			$(':checkbox:not(#check_all)').prop('checked',state);
			total();

		});
		// 单个选择，如果单个的都选择上了，全选的也要勾选上
		$(':checkbox:not(#check_all)').click(function(){
			if($(this).prop('checked')){
				if($(':checked').length+1 == $(':checkbox').length){
					$('#check_all').prop('checked', true);
				}
			}else{
				$('#check_all').prop('checked', false)
			}
			total();
		});

		$('.add').click(function(){
			// var num = parseFloat($(this).next().val());
			// $(this).next().val(num + 1);

			// 因为使用ajax后$this会指向 ajax对象,所以先存起来
			object = $(this);
			$.get('/cart/add'+$(this).prop('name')+'_1/', function(data){
				object.next().val(data.number);
				total();
			});
		});

		$('.minus').click(function(){
			var num = parseFloat($(this).prev().val());
			if(num>1){
				object = $(this);
				$.get('/cart/add'+$(this).prop('name')+'_-1/', function(data){
					object.prev().val(data.number);
					total();
				});
			}
		});

		$('.num_show').blur(function(){
			object = $(this);
			count = $(this).val();
			if(count <= 0){
				alert('请输入正确的数量');
				// $(this).focus();
				return;
			}else if(count>=100){
				alert('数量不能超过100');
				// $(this).focus();
				return;
			}

			$.get('/cart/edit'+$(this).prev().prop('name')+'_' +count+'/', function(data){
					object.val(data.number);
					total();
			});

		});



	});
</script>
{%endblock head%}
{%block inner_body%}
	<div class="total_count">全部商品<em class="total_count1">2</em>件</div>
	<ul class="cart_list_th clearfix">
		<li class="col01">商品名称</li>
		<li class="col02">商品单位</li>
		<li class="col03">商品价格</li>
		<li class="col04">数量</li>
		<li class="col05">小计</li>
		<li class="col06">操作</li>
	</ul>
	{%for c in carts%}
	<ul class="cart_list_td clearfix" id="{{c.id}}">
		<li class="col01"><input type="checkbox" name="" checked=""></li>
		<li class="col02"><img src="/static/{{c.goods.gpic}}/"></li>
		<li class="col03">{{c.goods.gtitle}}<br><em>{{c.goods.gprice}}元/{{c.goods.gunit}}</em></li>
		<li class="col04">{{c.goods.gunit}}</li>
		<li class="col05">{{c.goods.gprice}}元</li>
		<li class="col06">
			<div class="num_add">
				<a href="javascript:;" name="{{c.goods.id}}" class="add fl">+</a>
				<input type="text" class="num_show fl" value="{{c.count}}">
				<a href="javascript:;" name="{{c.goods.id}}" class="minus fl">-</a>
			</div>
		</li>
		<li class="col07">25.80元</li>
		<li class="col08"><a href="javascript:cart_del({{c.id}});">删除</a></li>
	</ul>
	{%endfor%}



	<ul class="settlements">
		<li class="col01"><input id="check_all" type="checkbox" name="" checked></li>
		<li class="col02">全选</li>
		<li class="col03">合计(不含运费)：<span>¥</span><em id="total">42.60</em><br>共计<b class="total_count2">0</b>件商品</li>
		<li class="col04"><a href="place_order.html">去结算</a></li>
	</ul>

{%endblock inner_body%}